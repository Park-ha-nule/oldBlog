---
layout: post
title:  무중단 배포란?
date:   2020-03-19 22:57:00 +0000
description: 무중단 배포의 의미, 무중단 배포가 필요한 이유, 무중단 배포의 종류
img: 무중단 배포.png
tags: [More]
author: begginer_
---

# 무중단 배포란?

Created: Mar 22, 2020

### <span style="color:blue;">무중단 배포란?</span>

---

 서버를 실제로 서비스할때 서비스적 장애와 배포에 있어서 부담감을 최소화할 수 있게끔 서비스가 중단되지 않고도 코드를 배포할 수 있는 기술을 의미한다.

### <span style="color:blue;">무중단 배포가 필요한 이유</span>

---

 실제로 서버를 배포할 때에 순서에 대해 생각해보자.

1. 80포트(혹은 다른 포트)에 우리의 서버를 띄운다.
2. 새롭게 배포할 내용이 있다고 하면 포트가 충돌나면 안 되기 때문에 서버를 다운시킨다.
3. (옵션)유저의 이탈을 방지하고자 공사중 이미지를 띄운다.
4. 80포트에 새롭게 배포할 서버를 띄운다.

 만약, 서버가 뜨는데 30초가 걸린다고 하면 최소 30+@초만큼 다운타임이 발생한다. 현대의 어플리케이션이라면 유저에게 최상의 경험을 제공해주기 위해 이런 다운타임이 없는 <span style="font-weight:bold;">무중단 배포</span>를 지원해야 한다.

[출처](https://perfectacle.github.io/2019/04/21/non-stop-deployment/)

### 필요 조건

---

 두 대 이상의 서버를 서비스해야한다. 다운타임이 발생하지 않기 위해서는 실제 서비스 중인 서버와 새롭게 배포한 서버가 동시에 존재해야한다. 비용을 줄이려면 배포할 때만 새로운 서버를 띄우고 완료된 후에 기존 서버는 죽이면 된다. 

### <span style="color:blue;">무중단 배포의 종류</span>

---

1. In-Place Deployment(현재위치 배포)

    : 현재 가동중인 서버 그대로 무중단 배포를 구현하기 때문에 현재위치 배포라고 불린다. 

<center><img src="/assets/img/무중단/01.png"></center>

<center>한개의 로드밸랜서가 4개의 서버로 골고루 요청을 보내고 있다.</center>

     모든 서버에 현재 1.0.1버전인데 이를 1.0.2버전으로 업데이트 하는데 현재위치 배포를 사용할 것이다.

    - 로드밸런서와 Server1과 Server2의 연결을 해제한다. 로드밸런서는 Server3과 Server4로만 요청을 보내게 된다.
    - 해제한 서버 두 개를 버전 1.0.2로 업데이트한다.
    - 업데이트한 서버를 로드밸런서에 연결한다.
    - 로드밸랜서에서 Server3과 Server4에 연결을 해제한다. 이 단계부터 클라이언트는 1.0.2버전의 서비를 사용할 수 있다.
    - Server3과 Server4를 앞에서 진행한대로 진행한 후 로드밸런서에 연결한다.

     이 방식은 서버를 증가하지 않고 로드밸런서에 해제하고 연결하는 작업을 통해 업데이트를 진행하고 현재 사용 가능한 자원을 그대로 사용하여 무중단 배포를 할 수 있다는 장점이 있다. 하지만 이 방법에는 2가지 단점이 있다.

    1. 서버를 나눠서 업데이트하기 때문에 업데이트 도중에는 사용가능한 서버가 필연적으로 적어진다.
    2. 만약 업데이트하고 싶은 버전에 문제가 있어서 버전을 롤백해야 하는 경우 같은 방식을 통해 롤백을 따로 진행해야 한다.

     1번 단점은 말그대로 네개가 돌아가던 서버가 업데이트 도중에는 두 개만 돌아가게 되면 요청이 몰려 서버에 부하가 걸린다. 물론 사용자가 가장 적게 이용하는 시간에 업데이트를 진행하겠지만 마음대로 시간을 정해서 업데이트 하지 못한다.(새벽에도 개발자는 일을 해야한다는 소리다.)

     2번 단점은 한 번의 롤백에만에도 배포 → 롤백 → 다시 배포의 3단계를 똑같이 진행해야 하기 떄문에 결코 효율적인 방법이 아니다. 게다가 롤백을 하면서 1번의 단점도 생각해야 한다.

2. Blue-Green Deployment

    : 현재위치 배포의 단점을 어느정도 보완할  수 있는 방법이다. 

<center><img src="/assets/img/무중단/02.png"></center>

<center>서버의 구조</center>

     현재위치 배포와 비슷하지만 이번에는 4개의 서버가 하나의 그룹에 들어가 있다. 

    - 우선 기존의 서버그룹과 같은 서버그룹을 하나 더 생성한다. 서버 버전도 동일하고 모든게 똑같지만 로드밸런서에 연결되어 있지는 않다.

<center><img src="/assets/img/무중단/03.png"></center>
<br>
    - 복사한 서버그룹 내부의 서버들을 1.0.2버전으로 업데이트를 진행한다. 여전히 로드밸런서에는 연결되어 있지 않다.
    - 업데이트가 진행된 복사한 서버그룹을 로드밸런서에 연결한다.
    - 기존에 존재하던 1.0.1버전 서버그룹을 로드밸런서에 연결 해제한다. 이 상태부터 사용자들은 온전히 1.0.2버전을 이요할 수 있게 된다.

    그냥 업데이트된 서버를 만들어서 기존 서버 대신 연결하는 방식으로 사용했다. 덕분에 현재위치 배포의 단점 두가지를 해결할 수 있었다.

    1. 업데이트를 진행하는 도중에 서버의 수는 그대로 유지되기 때문에 부하가 걸릴 위험이 사라진다.
    2. 만약 1.0.2버전에 문제가 있으면 아직 없애지 않은 1.0.1버전의 서버그룹으로 로드밸런서를 연결해 주기만 하면된다. 이후에 1.0.2버전의 문제를 해결하고 다시 로드밸런서만 옮겨서 연결하면 된다.

     하지만 이 방식에도 문제가 없는 건 아니다. 만약 서버가 구동중인 상황이 클라우드나 가상환경이 아닌 물리적인 서버로 존재한다면 기존에 있던 서버의 환경과 같은 수준의 서버를 두배로 늘렸다가 필요 없어지면 다시 줄이는 비효율적인 방식을 선택하는 것은 비용적인 문제가 발생한다. 한마디로, 물리적으로 존재하는 서버에서는 사용하기 어려우며 현재위치 배포 방식이 더 어울린다. 블루/그린 방식은 쉽게 인스턴스를 생성하고 없앨 수 있는 클라우드 환경이나, 컨테이너를 올렸다가 내리는 것이 자유로운 Docker등의 가상환경에 어울리는 방식이다.

    [출처](https://gist.github.com/ninanung/9d63304cb0d070642e89f9b94b6fe24b)